services:
  attu:
    container_name: milvus-attu
    image: zilliz/attu:latest
    restart: always
    ports:
      - "8000:3000"
    depends_on:
      milvus:
        condition: service_healthy
  openWebUI:
    container_name: open-webui
    image: ghcr.io/open-webui/open-webui:latest
    restart: always
    ports:
      - "3000:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - VECTOR_DB=milvus
      - MILVUS_HOST=milvus-standalone
      - MILVUS_PORT=19530
      - MILVUS_USERNAME=root
      - MILVUS_PASSWORD=milvus
      - MILVUS_COLLECTION=vector_store
    volumes:
      - ./data/open-webui:/app/backend/data
    depends_on:
      milvus:
        condition: service_healthy

  ollama:
    container_name: ollama
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ./data/ollama:/root/.ollama

  etcd:
    container_name: milvus-etcd
    image: quay.io/coreos/etcd:v3.5.12
    environment:
      - ETCD_AUTO_COMPACTION_RETENTION=1
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
      - ETCDCTL_API=3
      - ETCD_DATA_DIR=/etcd
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://milvus-etcd:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://milvus-etcd:2380
      - ETCD_INITIAL_CLUSTER=default=http://milvus-etcd:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
    healthcheck:
      test:
        [
          "CMD",
          "etcdctl",
          "--endpoints=http://127.0.0.1:2379",
          "endpoint",
          "health",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - "2379:2379"
      - "2380:2380"
    volumes:
      - ./data/etcd:/etcd

  minio:
    container_name: milvus-minio
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./data/minio:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fs http://localhost:9000/minio/health/live || wget -q --spider http://localhost:9000/minio/health/live",
        ]
      interval: 5s
      timeout: 3s
      retries: 10

  milvus:
    container_name: milvus-standalone
    image: milvusdb/milvus:latest
    command: milvus run standalone
    environment:
      - ETCD_ENDPOINTS=milvus-etcd:2379
      - MINIO_ADDRESS=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET_NAME=milvus
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - ./data/milvus:/var/lib/milvus
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:9091/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10

volumes:
  ollama-local:
    external: true
  open-webui-local:
    external: true
  milvus-data:
  minio-data:
  etcd-data:
